from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import logging

# Importar desde shared libraries
from hduce_shared.auth import JWTManager
from hduce_shared.config import settings
from hduce_shared.database import get_db_engine, create_all_tables

# Importar rutas locales - IMPORTANTE: usar import absoluto
import routes  # Cambiado de "from . import routes" a "import routes"

# Configurar logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(
    title="HDUCE Auth Service",
    description="Authentication and authorization microservice using shared-libraries",
    version="2.0.0"
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Incluir rutas
app.include_router(routes.router)

# Configurar JWT Manager usando shared-libs
# JWTManager configurado en routes.py - usa constantes de clase

# ==================== EVENTOS DE APLICACIÃ“N ====================

@app.on_event("startup")
async def startup_event():
    """Inicializar base de datos al iniciar"""
    try:
        # Crear tablas si no existen
        engine = get_db_engine(
            host=settings.database.postgres_host,
            port=settings.database.postgres_port,
            database=settings.database.auth_db,
            username=settings.database.postgres_user,
            password=settings.database.postgres_password
        )
        create_all_tables(engine)
        logger.info("âœ… Database tables verified/created")
    except Exception as e:
        logger.error(f"âŒ Database initialization failed: {e}")

@app.get("/")
async def root():
    """Root endpoint"""
    return {
        "service": "auth-service",
        "version": "2.0.0",
        "status": "running",
        "shared_libs": "enabled",
        "database": settings.database.auth_db,
        "port": 8000
    }

@app.get("/health")
async def health_check():
    """Health check endpoint"""
    return {"status": "healthy", "service": "auth", "shared_libs": True}

@app.get("/config")
async def show_config():
    """Mostrar configuraciÃ³n (solo para desarrollo)"""
    return {
        "database": {
            "host": settings.database.postgres_host,
            "port": settings.database.postgres_port,
            "database": settings.database.auth_db
        },
        "jwt": {
            "algorithm": settings.jwt.jwt_algorithm,
            "token_expiry_minutes": settings.jwt.access_token_expire_minutes
        }
    }



