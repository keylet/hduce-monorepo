import logging
from fastapi import FastAPI, HTTPException, Header
from fastapi.middleware.cors import CORSMiddleware
from hduce_shared.config import settings
from auth_client import auth_client
from . import routes  # Importar rutas locales

# Configurar logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(
    title="HDUCE User Service",
    description="User management microservice",
    version="2.0.0"
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ✅ INCLUIR ROUTER DE RUTAS
app.include_router(routes.router)

# ==================== SOLUCIÓN DEFINITIVA ====================
def crear_engine_user():
    """Solución definitiva - crea engine directamente"""
    from sqlalchemy import create_engine

    db = settings.database
    password = 'postgres'
    connection_string = f"postgresql://{db.postgres_user}:{password}@{db.postgres_host}:{db.postgres_port}/{db.user_db}"
    logger.info(f"Conectando a PostgreSQL: {db.postgres_host}:{db.postgres_port}/{db.user_db}")
    return create_engine(connection_string, pool_pre_ping=True)

@app.on_event("startup")
async def startup_event():
    """Inicializar base de datos al iniciar"""
    try:
        engine = crear_engine_user()
        try:
            from hduce_shared.database import create_all_tables
            create_all_tables(engine)
            logger.info("✅ Database tables verified/created")
        except ImportError:
            with engine.connect() as conn:
                conn.execute("SELECT 1")
            logger.info("✅ Conexión a DB establecida")
    except Exception as e:
        logger.error(f"❌ Database initialization failed: {e}")
        import traceback
        logger.error(traceback.format_exc())

@app.get("/health")
async def health_check():
    """Health check endpoint"""
    return {"status": "healthy", "service": "user", "shared_libs": True}

@app.get("/")
async def root():
    """Root endpoint"""
    return {
        "service": "user-service",
        "version": "2.0.0",
        "status": "running",
        "database": settings.database.user_db,
        "port": 8001
    }

@app.get("/protected-profile")
async def get_protected_profile(authorization: str = Header(None)):
    """Endpoint protegido que valida token con auth-service"""
    if not authorization or not authorization.startswith("Bearer "):
        raise HTTPException(status_code=401, detail="Missing authorization header")

    token = authorization.split(" ")[1]

    # Llamar al auth-service para validar token
    user_data = await auth_client.validate_token(token)

    if not user_data:
        raise HTTPException(status_code=401, detail="Invalid token")

    # Simular obtención de perfil de usuario
    return {
        "message": "Protected user profile",
        "user_id": user_data.get("user_id"),
        "email": user_data.get("email"),
        "profile": {
            "name": "John Doe",
            "role": "user",
            "created_at": "2024-01-01"
        }
    }

@app.on_event("shutdown")
async def shutdown_event():
    """Cerrar cliente HTTP al apagar"""
    await auth_client.close()

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8001)
