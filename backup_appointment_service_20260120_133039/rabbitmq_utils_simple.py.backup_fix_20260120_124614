"""
RabbitMQ Utils Simplificado - Usa pika directamente
Versión estable y confiable
"""
import json
import os
import pika
from typing import Dict, Any
from datetime import datetime

# Configuración
RABBITMQ_HOST = os.getenv("RABBITMQ_HOST", "rabbitmq")
RABBITMQ_PORT = int(os.getenv("RABBITMQ_PORT", "5672"))
RABBITMQ_USER = os.getenv("RABBITMQ_USER", "guest")
RABBITMQ_PASS = os.getenv("RABBITMQ_PASSWORD", "guest")

EXCHANGE = "appointments"
QUEUE = "appointment_notifications"
ROUTING_KEY = "notification.created"

class SimpleRabbitMQPublisher:
    """Publisher simple y confiable usando pika directamente"""
    
    def __init__(self):
        self.connection = None
        self.channel = None
        
    def connect(self):
        """Conectar a RabbitMQ"""
        try:
            credentials = pika.PlainCredentials(RABBITMQ_USER, RABBITMQ_PASS)
            parameters = pika.ConnectionParameters(
                host=RABBITMQ_HOST,
                port=RABBITMQ_PORT,
                credentials=credentials,
                heartbeat=600,
                blocked_connection_timeout=300
            )
            
            self.connection = pika.BlockingConnection(parameters)
            self.channel = self.connection.channel()
            
            # Declarar exchange
            self.channel.exchange_declare(
                exchange=EXCHANGE,
                exchange_type="direct",
                durable=True
            )
            
            # Declarar queue
            self.channel.queue_declare(
                queue=QUEUE,
                durable=True
            )
            
            # Bind queue a exchange
            self.channel.queue_bind(
                exchange=EXCHANGE,
                queue=QUEUE,
                routing_key=ROUTING_KEY
            )
            
            print(f"✅ Conectado a RabbitMQ en {RABBITMQ_HOST}:{RABBITMQ_PORT}")
            
        except Exception as e:
            print(f"❌ Error conectando a RabbitMQ: {e}")
            raise
    
    def publish_appointment_created(self, appointment_data: Dict[str, Any]) -> bool:
        """Publicar evento de cita creada"""
        try:
            if not self.connection or self.connection.is_closed:
                self.connect()
            
            # Crear mensaje
            message = {
                "event_type": "APPOINTMENT_CREATED",
                "timestamp": datetime.now().isoformat(),
                "data": appointment_data,
                "metadata": {
                    "service": "appointment",
                    "version": "1.0"
                }
            }
            
            # Publicar
            self.channel.basic_publish(
                exchange=EXCHANGE,
                routing_key=ROUTING_KEY,
                body=json.dumps(message, ensure_ascii=False),
                properties=pika.BasicProperties(
                    delivery_mode=2,  # Persistente
                    content_type='application/json',
                    timestamp=int(datetime.now().timestamp())
                )
            )
            
            print(f"✅ Evento publicado: APPOINTMENT_CREATED - Cita {appointment_data.get('id', 'N/A')}")
            return True
            
        except Exception as e:
            print(f"❌ Error publicando evento: {e}")
            return False
    
    def close(self):
        """Cerrar conexión"""
        if self.connection and not self.connection.is_closed:
            self.connection.close()
            print("✅ Conexión RabbitMQ cerrada")

# Singleton global
_publisher_instance = None

def get_publisher():
    """Obtener instancia singleton del publisher"""
    global _publisher_instance
    if _publisher_instance is None:
        _publisher_instance = SimpleRabbitMQPublisher()
    return _publisher_instance

def publish_appointment_created(appointment_data: Dict[str, Any]) -> bool:
    """Función principal para publicar eventos de citas creadas"""
    try:
        publisher = get_publisher()
        return publisher.publish_appointment_created(appointment_data)
    except Exception as e:
        print(f"❌ Error en publish_appointment_created: {e}")
        return False

# Alias para compatibilidad
publish_to_rabbitmq = publish_appointment_created

# Alias para compatibilidad
publish_appointment_event = publish_appointment_created
