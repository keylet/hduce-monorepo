events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    upstream auth_service { server hduce-auth-service:8000; }
    upstream user_service { server hduce-user-service:8001; }
    upstream appointment_service { server hduce-appointment-service:8002; }
    upstream notification_service { server hduce-notification-service:8003; }

    server {
        listen 80;
        server_name localhost;

        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log;

        location = / {
            return 200 "HDUCE API Gateway\n\nEndpoints:\n- /auth/\n- /api/v1/users/\n- /api/appointments/\n- /notifications/\n- /health";
            add_header Content-Type text/plain;
        }

        location = /health {
            return 200 "healthy";
            add_header Content-Type text/plain;
        }

        # Auth service
        location /auth/ {
            proxy_pass http://auth_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # User service  
        location /api/v1/users/ {
            proxy_pass http://user_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Appointment service - CORREGIDO
        location /api/appointments/ {
            proxy_pass http://appointment_service/api/appointments/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Notification service
        location /api/notifications/ {
            proxy_pass http://notification_service/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
